<?php

/**
 * This file is part of the package demosplan.
 *
 * (c) 2010-present DEMOS plan GmbH, for more information see the license file.
 *
 * All rights reserved
 */

namespace backend\core\Statement\Functional;

use demosplan\DemosPlanCoreBundle\DataFixtures\ORM\TestData\LoadUserData;
use demosplan\DemosPlanCoreBundle\Entity\Statement\Statement;
use demosplan\DemosPlanCoreBundle\Entity\Statement\StatementMeta;
use demosplan\DemosPlanCoreBundle\Exception\ViolationsException;
use demosplan\DemosPlanCoreBundle\Logic\Statement\StatementResourceTypeService;
use demosplan\DemosPlanCoreBundle\ResourceTypes\StatementResourceType;
use Tests\Base\FunctionalTestCase;

class StatementResourceTypeServiceTest extends FunctionalTestCase
{
    /** @var StatementResourceTypeService */
    protected $sut;

    public const SEGMENT_DRAFT_LIST = '{"data":{"id":"b34717f4-5935-4b2d-af58-d0e861f3a566","type":"SegmentedStatement","attributes":{"statementId":"dccc96d5-9991-4835-91fb-a9692cfae34e","procedureId":"e96a7861-81ba-4ea8-bebc-27fca88b419a","textualReference":"textualReference","segments":[{"id":"8ad049d6-9367-444e-b82c-734c91d7c2a9","charStart":2250,"charEnd":2471,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B","id":"c87a3665-51b2-4c8b-97c5-9334918cf0e8"}],"charStartInit":3448,"charEndInit":3537,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"c8da4156-d3e4-4f43-af54-616375226a80","charStart":3182,"charEnd":3439,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B","id":"c87a3665-51b2-4c8b-97c5-9334918cf0e8"}],"charStartInit":3537,"charEndInit":4008,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"3fca8ad3-91d1-4cf6-ae9d-8581f6d93fe4","charStart":3441,"charEnd":3676,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"charStartInit":4009,"charEndInit":4053,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"ec34b2a7-4698-4161-8fb8-6638498cbbbd","charStart":3678,"charEnd":3693,"place":{"id":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","name":"A"},"tags":[{"tagName":"B","id":"646d21a9-3a4f-4c4d-a3ea-a66b63b86095"}],"charStartInit":4053,"charEndInit":4185,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd"},{"id":"0d3dbcce-7d2e-431c-95b9-2bd462a5d46b","charStart":3695,"charEnd":4333,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7","tagName":"B","tagScore":0}],"charStartInit":4186,"charEndInit":4632,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"3147fa9a-5ea4-45c4-ba30-5b379f81abd1","charStart":4335,"charEnd":4906,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"id":"4b8fdcb5-efb7-47b2-95ae-23fd0ff33e30","tagName":"B","tagScore":0}],"charStartInit":5202,"charEndInit":5456,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"2004b9fc-ae87-11eb-9694-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"e9829180-8935-4ed5-a916-c96e44583534","charStart":4908,"charEnd":5424,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B","id":"4b8fdcb5-efb7-47b2-95ae-23fd0ff33e30"}],"charStartInit":5597,"charEndInit":5677,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"2004b9fc-ae87-11eb-9694-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"d400588e-329f-4128-a37e-9e1d5414a8ef","charStart":5191,"charEnd":5266,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"id":"deb994cd-4594-415a-9ed5-763189b7a563","tagName":"B","tagScore":0},{"id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7","tagName":"B ","tagScore":0},{"id":"565708ad-bf92-47ed-baf4-95876515dd08","tagName":"B","tagScore":0},{"id":"2215ef27-243d-49bc-ba11-8d4b8cf0c6b9","tagName":"B","tagScore":0}],"charStartInit":5747,"charEndInit":5822,"hasProsemirrorIndex":true,"status":false,"text":"text"},{"id":"5495c169-c53c-42e7-8787-8b3e9b716bd7","charStart":5491,"charEnd":6804,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B","id":"f35a12fa-1069-4092-ac5b-ef18cc3dedf5"}],"charStartInit":6191,"charEndInit":6278,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"2004b9fc-ae87-11eb-9694-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"05021b15-ff3a-43df-bdd3-dcd36ba18405","charStart":6806,"charEnd":6922,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"charStartInit":7339,"charEndInit":7822,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"44aa104d-0f4a-43de-b24a-6fdbd3711a42","charStart":7121,"charEnd":7667,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"charStartInit":8183,"charEndInit":8323,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"6957bfce-5027-42a9-9072-8d5d8841ae30","charStart":8145,"charEnd":8150,"place":{"id":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","name":"A"},"tags":[{"tagName":"B","id":"646d21a9-3a4f-4c4d-a3ea-a66b63b86095"}],"charStartInit":9066,"charEndInit":9200,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd"},{"id":"37cde023-e9b8-42a8-946f-5cb13ddeab13","charStart":8254,"charEnd":8337,"place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"tags":[{"tagName":"B","id":"84701b6d-c593-429d-9b77-5d5be6ab0da6"}],"charStartInit":9200,"charEndInit":9298,"hasProsemirrorIndex":true,"status":"confirmed","text":"text","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed"},{"id":"7cfff312-1702-4720-826b-36d34e3785be","charStart":2081,"charEnd":2246,"tags":[{"tagName":"B ","id":"5132025a-12db-41ca-a35f-f5dd0d6b5d20"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"eceb01d3-7008-4dda-b458-c76f1771c4a8","charStart":1,"charEnd":50,"tags":[{"tagName":"B","id":"646d21a9-3a4f-4c4d-a3ea-a66b63b86095"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","place":{"id":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","name":"A"}},{"id":"04d557b0-30ce-4c09-b8ff-4c54b0af324a","charStart":52,"charEnd":309,"tags":[{"tagName":"B","id":"d8fe383c-244e-4f62-bd2b-abd099de94d4"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"6fd06324-1ac6-4cd7-a96a-2215a77bb70c","charStart":311,"charEnd":340,"tags":[{"tagName":"B","id":"646d21a9-3a4f-4c4d-a3ea-a66b63b86095"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","place":{"id":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","name":"A"}},{"id":"d49de8dc-7f5a-41b0-80ab-6d8a473b58d0","charStart":342,"charEnd":1141,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"586f76ed-f6b2-4f07-8795-424b0b660b88","charStart":1923,"charEnd":2077,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"7d3a8d93-2781-432c-adf6-e86074bf529e","charStart":1793,"charEnd":1919,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"text":"text"},{"id":"5251073b-e2fe-4782-8a66-0c2df25131a8","charStart":1688,"charEnd":1789,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"},"text":"text"},{"id":"5f89b713-c59a-40c7-99cf-1066919ccc8a","charStart":1145,"charEnd":1542,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"e492f8d2-b1e7-4f08-98ac-ebd383340ab6","charStart":1542,"charEnd":1684,"tags":[{"tagName":"B","id":"b93afde9-dddc-49da-9596-b1b288fb89c9"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"dfa9b6e9-a87e-47a5-89c6-b3de942252e8","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"0081d07b-44fd-47b1-a1f7-1fdf8e3303bb","charStart":2475,"charEnd":3178,"tags":[{"tagName":"B","id":"552edffc-9a99-46d5-85b5-981fecc62499"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"17ad3b1d-4537-4fe2-8589-a4d9e077200d","charStart":5426,"charEnd":5489,"tags":[{"tagName":"B","id":"646d21a9-3a4f-4c4d-a3ea-a66b63b86095"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","place":{"id":"7735ebc9-9913-45cb-94d7-7249ff9d2dcd","name":"A"}},{"id":"50c378da-cdcb-43ac-ac78-06867c54b99f","charStart":6992,"charEnd":7119,"tags":[{"tagName":"B","id":"b93afde9-dddc-49da-9596-b1b288fb89c9"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"dfa9b6e9-a87e-47a5-89c6-b3de942252e8","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"c01de1a2-1d5b-4c57-a226-af5ba1d80f66","charStart":6923,"charEnd":6990,"tags":[{"tagName":"B ","id":"4b8fdcb5-efb7-47b2-95ae-23fd0ff33e30"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"2004b9fc-ae87-11eb-9694-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"42f950e0-2a7d-4ac9-b9cf-bdba7ce4fef1","charStart":7669,"charEnd":7746,"tags":[{"tagName":"B ","id":"4b8fdcb5-efb7-47b2-95ae-23fd0ff33e30"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"2004b9fc-ae87-11eb-9694-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"6563c0fb-124b-48d9-8d11-1cf7fdbc3951","charStart":7748,"charEnd":8143,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"82ff01b3-dd82-4470-8bfb-ba7c7ea07093","charStart":8152,"charEnd":8250,"tags":[{"tagName":"B","id":"d8fe383c-244e-4f62-bd2b-abd099de94d4"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"4b025094-0a66-11ec-94a0-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"15cd6072-1707-4bea-82da-a1ff667d2ed9","charStart":8341,"charEnd":8432,"tags":[{"tagName":"B ","id":"4b8fdcb5-efb7-47b2-95ae-23fd0ff33e30"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"2004b9fc-ae87-11eb-9694-96000008770a","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"7576be8e-17b6-4b59-b093-1fa43f7ebee8","charStart":8436,"charEnd":8568,"tags":[{"tagName":"B ","id":"f7eb811f-e096-45b6-b2b1-ff0f552a54c7"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"75ce6b7e-b2bb-4104-8067-be347d8b5316","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}},{"id":"65d48799-4151-4b52-82ca-1ffe2f67eb7d","charStart":8572,"charEnd":8859,"tags":[{"tagName":"B","id":"09b6b698-c1ac-4aa7-8e40-d117a0427e49"}],"hasProsemirrorIndex":true,"status":"confirmed","assigneeId":"e7600f56-41a0-4941-bd6c-65a98b20929d","placeId":"2b67c367-d013-4bef-8815-ab98a70542ed","place":{"id":"2b67c367-d013-4bef-8815-ab98a70542ed","name":"A"}}]}}}';

    protected function setUp(): void
    {
        parent::setUp();

        $this->sut = $this->getContainer()->get(StatementResourceTypeService::class);
        $user = $this->getUserReference(LoadUserData::TEST_USER_2_PLANNER_ADMIN);
        $this->logIn($user);
    }

    public function testUpdate(): void
    {
        $statementMeta = new StatementMeta();
        $statementMeta->setMiscData([
            StatementMeta::SUBMITTER_ROLE => StatementMeta::SUBMITTER_ROLE_CITIZEN,
        ]);
        $testProcedure = $this->fixtures->getReference('testProcedure');
        $statement = new Statement();
        $statement->setProcedure($testProcedure);
        $statement->setMeta($statementMeta);
        $this->expectException(ViolationsException::class);

        $this->sut->update($statement, StatementResourceType::startPath(), ['segmentDraftList' => self::SEGMENT_DRAFT_LIST]);
    }
}
