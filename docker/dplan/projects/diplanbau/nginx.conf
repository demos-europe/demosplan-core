# Evaluate XDEBUG_SESSION cookie to enable fpm pool switching
# between the one with enabled xdebug and the one with disabled xdebug
# https://jtreminio.com/blog/developing-at-full-speed-with-xdebug/
map $cookie_XDEBUG_SESSION $my_fastcgi_pass {
    default unix:/var/run/php/php7.4-fpm.sock;
    ~*phpstorm unix:/var/run/php/php7.4-fpm-xdebug.sock;
    ~*eclipse unix:/var/run/php/php7.4-fpm-xdebug.sock;
}

server
{
    listen 80;
    listen [::]:80;

    server_name ~^((.*?)(?:\.))?(?!debug)(?<project_name>[a-z-]+)\.dplan(\.local)?$;

    if (!-d /srv/www/public) {
        set $project_server_root /srv/www/projects/diplanbau/web;
    }

    if (-d /srv/www/public) {
        set $project_server_root /srv/www/public;
        set $is_mono_repo true;
    }

    root $project_server_root;

    include symfony;
}

server
{
    listen 80;
    server_name dns.debug.dplan;

    location / {
        set $upstream_host http://172.20.255.1:5380;
        proxy_pass $upstream_host;
    }
}

server
{
    listen 80;
    server_name mail.debug.dplan;

    location / {
        set $upstream_host http://127.0.0.1:8025;

        chunked_transfer_encoding on;
        proxy_set_header X-NginX-Proxy true;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_buffering off;

        proxy_pass $upstream_host;
    }
}

server
{
    resolver 127.0.0.11 valid=30s;

    listen 80;
    server_name ~^(mq|rabbitmq).debug.dplan$;

    location / {
        set $upstream_host http://rabbitmq:15672;
        proxy_pass $upstream_host;
    }
}

server
{
    resolver 127.0.0.11 valid=30s;

    listen 80;
    server_name ~^(es|elasticsearch).debug.dplan$;

    location / {
        set $upstream_host http://searchadm:9000;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_pass $upstream_host;
    }
}
