name: Format (PHP)

on:
    pull_request:
        paths:
            - '**.php'
            - '.php-cs-fixer.php'
            - '!lib/**'
jobs:
    cancel:
        name: 'Cancel Previous Runs'
        runs-on: ubuntu-latest
        timeout-minutes: 3
        steps:
            -   uses: styfle/cancel-workflow-action@0.10.0
                with:
                    workflow_id: "php-cs-fixer"
                    access_token: ${{ secrets.GITHUB_TOKEN }}
    php-cs-fixer:
        runs-on: ubuntu-20.04
        steps:
            -   uses: actions/checkout@v3
                with:
                    ref: ${{ github.head_ref }}

            -   name: Cache php dependencies
                uses: actions/cache@v3.0.8
                with:
                    path: |
                        ~/.composer/cache
                        vendor
                    key: ${{ runner.os }}-build-php-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-build-php-${{ hashFiles('**/composer.lock') }}
            -   name: Setup PHP with composer v2
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '7.4'
                    extensions: gd soap sockets zip
                    tools: composer:v2

            -   name: Install composer dependencies
                run: |
                    composer --version
                    composer install --no-interaction
            -   name: Get list of changed files
                uses: jitterbit/get-changed-files@v1
                id: files

            -   name: download configs
                run: |
                    wget --header "Authorization: Token ${{ secrets.DEMOSCI_PAT }}" https://raw.githubusercontent.com/demos-europe/demosplan-infrastructure/main/php-cs-fixer/.php-cs-fixer-header.php -O .php-cs-fixer-header.php
                    wget --header "Authorization: Token ${{ secrets.DEMOSCI_PAT }}" https://raw.githubusercontent.com/demos-europe/demosplan-infrastructure/main/php-cs-fixer/.php-cs-fixer.php -O .php-cs-fixer.php

            -   name: Run php-cs-fixer
                run: "vendor/bin/php-cs-fixer fix --config .php-cs-fixer.php ${{ steps.files.outputs.added_modified }}"

            -   name: Run php-cs-fixer-header
                run: "vendor/bin/php-cs-fixer fix --config .php-cs-fixer-header.php ${{ steps.files.outputs.added_modified }}"

            -   name: delete headerWriter
                run: rm .php-cs-fixer-header.php .php-cs-fixer.php
                shell: bash

            -   name: Configure git
                run: |
                    git config  user.email ${{ secrets.DEVOPS_GPG_EMAIL }}
                    git config  user.name "Demos-CI"
            -   name: Commit
                run: |
                    if ! git diff --exit-code; then
                    git pull
                    git add .
                    git commit -m "style: Apply php-cs-fixer" --no-gpg-sign
                    git push
                    fi
