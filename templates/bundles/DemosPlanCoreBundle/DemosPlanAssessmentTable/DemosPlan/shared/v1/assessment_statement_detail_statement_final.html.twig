<fieldset>
    <dp-accordion
        data-cy="statementDetail:statementFinalSend"
        title="{{ "statement.final.send"|trans }}">
        <div class="o-box--dark u-ph u-pv-0_5">
            {# Determine if statement has feedback value set (authorFeedback is true means citizen wants feedback) #}
            {% set hasFeedbackValue = templateVars.table.statement.meta.authorFeedback is defined and templateVars.table.statement.meta.authorFeedback == true %}

            {% if templateVars.sendFinalEmail is defined and templateVars.sendFinalEmail == false %}
                {# If feature is now disabled, show note that statement was created when feature was enabled #}
                {% if not templateVars.table.procedure.settings.publicParticipationFeedbackEnabled %}
                    <p class="flash-info u-mb-0_5">{{ "note.statement.created.when.feature.enabled.postal"|trans }}</p>
                {% endif %}
                {{ "explanation.no.statement.final.sent"|trans }}
            {% elseif constant('demosplan\\DemosPlanCoreBundle\\Entity\\Statement\\Statement::EXTERNAL') == templateVars.table.statement.publicStatement
                and not hasFeedbackValue
                and not templateVars.table.procedure.settings.publicParticipationFeedbackEnabled %}
                {# Statement has no feedback value AND feature is disabled - show feature disabled message #}
                {{ "explanation.statement.final.feedback.feature.disabled"|trans }}
            {% elseif constant('demosplan\\DemosPlanCoreBundle\\Entity\\Statement\\Statement::EXTERNAL') == templateVars.table.statement.publicStatement
                and not hasFeedbackValue %}
                {# Statement has no feedback value - citizen doesn't want feedback #}
                {{ "explanation.no.statement.final.no.feedback.wanted"|trans }}
            {% elseif templateVars.email2|default()|length == 0 %}
                {{ "explanation.no.statement.final.no.email"|trans }}
            {% else %}
                {# Show note if feature is currently disabled but statement has feedback value #}
                {% if not templateVars.table.procedure.settings.publicParticipationFeedbackEnabled and hasFeedbackValue %}
                    <p class="flash flash-info u-mb-0_5">{{ "note.statement.created.when.feature.enabled.form.shown"|trans }}</p>
                {% endif %}

                {% if templateVars.finalEmailOnlyToVoters is defined and templateVars.finalEmailOnlyToVoters == true %}
                    {{ "explanation.statement.final.sent.only.voters"|trans }}
                {% endif %}

                {% if templateVars.table.statement.sentAssessment is defined and templateVars.table.statement.sentAssessment == true %}
                    <p>{{ "confirm.statement.final.sent.date"|trans({'date': templateVars.table.statement.sentAssessmentDate|dplanDate('d.m.Y | H:i') })|wysiwyg }}</p>
                {% else %}
                    <p>{{ "confirm.statement.final.not.sent"|trans }}</p>
                {% endif %}

                {% if hasPermission('field_organisation_email2_cc') %}
                    <label>
                        {{ "email.recipient"|trans }}
                        <p class="lbl--text color--grey">
                            {% if templateVars.table.statement.publicStatement == 'external' %}
                                {{ "explanation.statement.final.citizen.email.hidden"|trans }}
                            {% else %}
                                {{ templateVars.email2|default() }}
                            {% endif %}
                            {% if templateVars.ccEmail2 is defined and templateVars.ccEmail2 != false  %}, {{ 'recipients.additional'|trans }}: {{ templateVars.ccEmail2|default() }}{% endif %}
                        </p>
                    </label>
                {% endif %}

                {{ uiComponent('form.row', {
                    elements: [
                        {
                            label: { text: 'email.cc'|trans, hint: 'explanation.email.cc' },
                            control: { name: 'r_send_emailCC', value: templateVars.emailsCC|default },
                            id: 'r_send_emailCC',
                            type: 'text',
                            disabled: readonly,
                            attributes: ['data-cy=statementDetail:sendEmailCC']
                        }
                    ]
                }) }}

                {{ uiComponent('form.row', {
                    elements: [
                        {
                            label: { text: 'subject'|trans },
                            control: { name: 'r_send_title', value: 'statement.final.email.subject'|trans({ procedureName: templateVars.table.procedure.name|default }) },
                            id: 'r_send_title',
                            type: 'text',
                            disabled: readonly,
                            attributes: ['data-cy=statementDetail:sendTitle']
                        }
                    ]
                }) }}

                {# set as include to be easily overridden in Projects #}
                {% set predefinedText -%}
                    {{ include('@DemosPlanCore/DemosPlanAssessmentTable/DemosPlan/shared/v1/assessment_statement_detail_statement_final_emailtext.html.twig') }}
                {%- endset %}

                <detail-view-final-email-body
                    class="u-mb-0_5"
                    data-cy="statementDetail:emailBodyText"
                    init-text="{{ predefinedText|default }}"
                    procedure-id="{{ templateVars.table.procedure.ident }}">
                </detail-view-final-email-body>

                {% if not readonly %}
                    <div class="layout--flush">
                        <div class="layout__item u-1-of-1">
                            {{
                            fileupload(
                                "r_attachments",
                                "documents.attach",
                                "all",
                                "form.button.upload.files",
                                20,
                                true
                            )
                            }}
                        </div>
                    </div>

                    <div class="text-right">
                        <button
                            class="btn btn--primary btn--outline"
                            data-cy="statementDetail:emailAttachmentsSend"
                            data-send-form="{# This attribute is used as a hook to append an EventListener in assessment_statement.html.twig #}"
                            type="button">
                            <i
                                class="fa fa-envelope u-mr-0_125"
                                aria-hidden="true"></i>
                            {{ 'send'|trans }}
                        </button>
                    </div>
                {% endif %}

            {% endif %}
        </div>
    </dp-accordion>
</fieldset>
